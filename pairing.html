<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>PASIYA MD ‚Äî Link Device</title>
<style>
/* ============================================================
   PASIYA MD  ‚Äî  Pairing Page
   Dark bg ¬∑ Light-blue text ¬∑ Dot-to-dot animated canvas
   ============================================================ */
@import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&family=Exo+2:wght@300;400;600;700&display=swap');

:root {
  --bg:        #080b12;
  --card:      #0e1220;
  --card-glow: rgba(0,200,255,0.06);
  --cyan:      #00c8ff;
  --cyan-dim:  #0078a0;
  --cyan-glow: rgba(0,200,255,0.30);
  --white:     #e0eef8;
  --white-dim: #6e8da8;
  --green:     #00e676;
  --red:       #ff4757;
  --border:    rgba(0,200,255,0.12);
}

* { margin:0; padding:0; box-sizing:border-box; }

body {
  background: var(--bg);
  color: var(--white);
  font-family: 'Exo 2', sans-serif;
  min-height: 100vh;
  overflow: hidden;
  position: relative;
}

/* ============================================================
   DOT-TO-DOT CANVAS (full-screen animated background)
   ============================================================ */
#canvas {
  position: fixed;
  inset: 0;
  width: 100%;
  height: 100%;
  z-index: 0;
  pointer-events: none;
}

/* ============================================================
   LAYOUT OVERLAY
   ============================================================ */
.overlay {
  position: relative;
  z-index: 10;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 24px;
}

/* ============================================================
   LOGO HEADER
   ============================================================ */
.logo-wrap {
  text-align: center;
  margin-bottom: 36px;
  animation: fadeDown 0.7s ease both;
}
.logo-wrap svg { width: 72px; height: 72px; filter: drop-shadow(0 0 18px var(--cyan-glow)); }
.logo-wrap .title {
  font-family: 'Rajdhani', sans-serif;
  font-size: 2.4rem;
  font-weight: 700;
  letter-spacing: 5px;
  text-transform: uppercase;
  color: var(--cyan);
  margin-top: 10px;
  text-shadow: 0 0 20px var(--cyan-glow);
}
.logo-wrap .sub {
  font-size: 0.72rem;
  color: var(--white-dim);
  letter-spacing: 4px;
  text-transform: uppercase;
  margin-top: 4px;
}

/* ============================================================
   CARD
   ============================================================ */
.card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 20px;
  padding: 36px 40px;
  width: 100%;
  max-width: 440px;
  position: relative;
  overflow: hidden;
  box-shadow: 0 8px 40px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.04);
  animation: fadeUp 0.6s ease 0.15s both;
}
.card::before {
  content:'';
  position:absolute; top:0; left:0; right:0; height:2px;
  background: linear-gradient(90deg, transparent, var(--cyan), transparent);
}

/* ============================================================
   STEP INDICATORS  (1 ‚Üí 2 ‚Üí 3)
   ============================================================ */
.steps {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0;
  margin-bottom: 32px;
}
.step {
  display: flex;
  flex-direction: column;
  align-items: center;
  position: relative;
}
.step-num {
  width: 32px; height: 32px;
  border-radius: 50%;
  border: 2px solid var(--cyan-dim);
  display: flex; align-items: center; justify-content: center;
  font-family: 'Rajdhani',sans-serif;
  font-size: 0.85rem; font-weight: 700;
  color: var(--cyan-dim);
  transition: all 0.4s;
}
.step.active .step-num {
  border-color: var(--cyan);
  color: var(--cyan);
  box-shadow: 0 0 12px var(--cyan-glow);
}
.step.done .step-num {
  background: var(--green);
  border-color: var(--green);
  color: #000;
}
.step-label {
  font-size: 0.58rem;
  color: var(--white-dim);
  margin-top: 6px;
  letter-spacing: 1px;
  text-transform: uppercase;
  text-align: center;
  white-space: nowrap;
}
.step-line {
  width: 60px; height: 2px;
  background: var(--cyan-dim);
  opacity: 0.35;
  margin: 0 6px;
  margin-bottom: 18px;
  transition: background 0.4s, opacity 0.4s;
}
.step-line.active { background: var(--cyan); opacity: 0.7; }

/* ============================================================
   FORM ELEMENTS
   ============================================================ */
.label {
  font-size: 0.7rem;
  color: var(--cyan);
  letter-spacing: 2px;
  text-transform: uppercase;
  margin-bottom: 8px;
  display: block;
}

.input-wrap {
  position: relative;
}
.input-wrap .flag {
  position: absolute; left: 14px; top: 50%; transform: translateY(-50%);
  font-size: 1.1rem;
  pointer-events: none;
}
input[type="tel"] {
  width: 100%;
  padding: 14px 16px 14px 44px;
  background: rgba(0,200,255,0.04);
  border: 1px solid var(--border);
  border-radius: 12px;
  color: var(--white);
  font-family: 'Exo 2',sans-serif;
  font-size: 1rem;
  letter-spacing: 2px;
  outline: none;
  transition: border-color 0.3s, box-shadow 0.3s;
}
input[type="tel"]::placeholder { color: var(--white-dim); letter-spacing: 1px; }
input[type="tel"]:focus {
  border-color: var(--cyan);
  box-shadow: 0 0 16px var(--cyan-glow);
}

/* ============================================================
   BUTTONS
   ============================================================ */
.btn {
  width: 100%;
  margin-top: 20px;
  padding: 14px;
  border: none;
  border-radius: 12px;
  font-family: 'Rajdhani',sans-serif;
  font-size: 1rem;
  font-weight: 700;
  letter-spacing: 3px;
  text-transform: uppercase;
  cursor: pointer;
  transition: all 0.3s;
  position: relative;
  overflow: hidden;
}
.btn-primary {
  background: linear-gradient(135deg, var(--cyan), #0078c8);
  color: #000;
  box-shadow: 0 4px 20px var(--cyan-glow);
}
.btn-primary:hover {
  box-shadow: 0 6px 28px rgba(0,200,255,0.45);
  transform: translateY(-1px);
}
.btn-primary:active { transform: translateY(0); }
.btn-primary:disabled {
  opacity: 0.4;
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
}

.btn-copy {
  background: transparent;
  border: 1px solid var(--border) !important;
  color: var(--cyan);
  width: auto;
  margin-top: 0;
  padding: 8px 18px;
  font-size: 0.7rem;
  letter-spacing: 2px;
  border-radius: 8px;
  display: inline-flex;
  align-items: center;
  gap: 6px;
}
.btn-copy:hover { border-color: var(--cyan) !important; background: rgba(0,200,255,0.06); }

/* ============================================================
   PAIR CODE DISPLAY
   ============================================================ */
.code-box {
  display: none;
  margin-top: 28px;
  text-align: center;
  animation: fadeUp 0.4s ease both;
}
.code-box.visible { display: block; }

.code-display {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  margin: 12px 0;
}
.code-val {
  font-family: 'Rajdhani',sans-serif;
  font-size: 2.6rem;
  font-weight: 700;
  color: var(--cyan);
  letter-spacing: 8px;
  text-shadow: 0 0 16px var(--cyan-glow);
  user-select: all;
}
.code-hint {
  font-size: 0.65rem;
  color: var(--white-dim);
  letter-spacing: 1px;
  margin-top: 4px;
  line-height: 1.6;
}

/* ============================================================
   WAITING / CONNECTED STATES
   ============================================================ */
.waiting-box {
  display: none;
  margin-top: 24px;
  text-align: center;
  animation: fadeUp 0.4s ease both;
}
.waiting-box.visible { display: block; }

.spinner {
  width: 36px; height: 36px;
  border: 3px solid var(--border);
  border-top-color: var(--cyan);
  border-radius: 50%;
  margin: 0 auto 14px;
  animation: spin 0.8s linear infinite;
  box-shadow: 0 0 12px var(--cyan-glow);
}
@keyframes spin { to { transform: rotate(360deg); } }

.waiting-text {
  font-size: 0.78rem;
  color: var(--white-dim);
  letter-spacing: 1px;
}

/* ============================================================
   CONNECTED SUCCESS
   ============================================================ */
.success-box {
  display: none;
  text-align: center;
  animation: fadeUp 0.5s ease both;
}
.success-box.visible { display: block; }

.success-icon {
  width: 64px; height: 64px;
  background: linear-gradient(135deg, var(--green), #00b85a);
  border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  margin: 0 auto 16px;
  font-size: 2rem;
  box-shadow: 0 0 24px rgba(0,230,118,0.35);
  animation: pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) both;
}
@keyframes pop { 0%{transform:scale(0)} 100%{transform:scale(1)} }

.success-title {
  font-family: 'Rajdhani',sans-serif;
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--green);
  letter-spacing: 2px;
  text-transform: uppercase;
}
.success-sub { font-size: 0.72rem; color: var(--white-dim); margin-top: 6px; }

.btn-dashboard {
  margin-top: 20px;
  background: linear-gradient(135deg, var(--green), #00b85a);
  color: #000;
  box-shadow: 0 4px 20px rgba(0,230,118,0.3);
}
.btn-dashboard:hover { box-shadow: 0 6px 28px rgba(0,230,118,0.45); transform: translateY(-1px); }

/* ============================================================
   ERROR MSG
   ============================================================ */
.err-msg {
  display: none;
  margin-top: 14px;
  padding: 10px 14px;
  background: rgba(255,71,87,0.08);
  border: 1px solid rgba(255,71,87,0.25);
  border-radius: 10px;
  color: var(--red);
  font-size: 0.72rem;
  letter-spacing: 0.5px;
  text-align: center;
  animation: fadeUp 0.3s ease both;
}
.err-msg.visible { display: block; }

/* ============================================================
   FOOTER
   ============================================================ */
.footer-text {
  position: fixed; bottom: 20px; left: 0; right: 0;
  text-align: center;
  font-size: 0.6rem;
  color: var(--white-dim);
  letter-spacing: 2px;
  z-index: 10;
  opacity: 0.5;
}
.footer-text span { color: var(--cyan); }

/* ============================================================
   KEYFRAMES
   ============================================================ */
@keyframes fadeUp   { from{opacity:0;transform:translateY(20px)} to{opacity:1;transform:translateY(0)} }
@keyframes fadeDown { from{opacity:0;transform:translateY(-14px)} to{opacity:1;transform:translateY(0)} }
</style>
</head>
<body>

<!-- DOT-TO-DOT ANIMATED CANVAS -->
<canvas id="canvas"></canvas>

<!-- MAIN OVERLAY -->
<div class="overlay">

  <!-- LOGO -->
  <div class="logo-wrap">
    <svg viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <linearGradient id="lg1" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" stop-color="#00c8ff"/>
          <stop offset="50%" stop-color="#0078c8"/>
          <stop offset="100%" stop-color="#00c8ff"/>
        </linearGradient>
        <filter id="glow"><feGaussianBlur stdDeviation="2.5" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
      </defs>
      <circle cx="40" cy="40" r="36" fill="none" stroke="url(#lg1)" stroke-width="2.2" opacity="0.55"/>
      <polygon points="40,12 64,26 64,54 40,68 16,54 16,26" fill="none" stroke="url(#lg1)" stroke-width="1.8" opacity="0.4" filter="url(#glow)"/>
      <text x="40" y="50" text-anchor="middle" font-family="Rajdhani,sans-serif" font-size="28" font-weight="700" fill="url(#lg1)" filter="url(#glow)">P</text>
      <circle cx="40" cy="7" r="2.2" fill="#00c8ff" opacity="0.8"/>
      <circle cx="40" cy="73" r="2.2" fill="#0078c8" opacity="0.7"/>
    </svg>
    <div class="title">PASIYA MD</div>
    <div class="sub">Link Your WhatsApp Device</div>
  </div>

  <!-- CARD -->
  <div class="card" id="mainCard">

    <!-- STEP BAR -->
    <div class="steps">
      <div class="step active" id="step1"><div class="step-num">1</div><div class="step-label">Number</div></div>
      <div class="step-line" id="line1"></div>
      <div class="step active" id="step2"><div class="step-num">2</div><div class="step-label">Code</div></div>
      <div class="step-line" id="line2"></div>
      <div class="step" id="step3"><div class="step-num">3</div><div class="step-label">Connected</div></div>
    </div>

    <!-- PHASE 1: Phone input -->
    <div id="phase1">
      <label class="label">Enter Your WhatsApp Number</label>
      <div class="input-wrap">
        <span class="flag">üåè</span>
        <input type="tel" id="phoneInput" placeholder="94 77 123 4567" autocomplete="off" maxlength="20"/>
      </div>
      <button class="btn btn-primary" id="btnPair">Generate Code</button>
      <div class="err-msg" id="errMsg"></div>
    </div>

    <!-- PHASE 2: Pair code revealed -->
    <div class="code-box" id="phase2">
      <label class="label">Your Pair Code</label>
      <div class="code-display">
        <span class="code-val" id="codeVal">----</span>
        <button class="btn-copy" id="btnCopy">üìã Copy</button>
      </div>
      <div class="code-hint">
        Open <strong style="color:var(--cyan)">WhatsApp</strong> on your phone<br/>
        ‚Üí Settings ‚Üí Linked Devices ‚Üí Link a device<br/>
        ‚Üí <em>Instead of scanning, enter code below</em><br/>
        Paste this code there. A notification will arrive.
      </div>
    </div>

    <!-- PHASE 3: Waiting for link -->
    <div class="waiting-box" id="phase3">
      <div class="spinner"></div>
      <div class="waiting-text">Waiting for WhatsApp to confirm‚Ä¶<br/><span style="color:var(--white-dim);font-size:0.6rem;">Check your WhatsApp for the notification</span></div>
    </div>

    <!-- PHASE 4: Connected! -->
    <div class="success-box" id="phase4">
      <div class="success-icon">‚úì</div>
      <div class="success-title">Connected!</div>
      <div class="success-sub">PASIYA MD is now linked and running 24/7</div>
      <button class="btn btn-dashboard" onclick="window.location='/dashboard'">‚Üí Go to Dashboard</button>
    </div>

  </div><!-- .card -->
</div><!-- .overlay -->

<div class="footer-text">üåü <span>PASIYA MD</span> ‚Äî Link Device ‚Äî 24/7 WhatsApp Bot</div>

<!-- ============================================================
     JAVASCRIPT
     ============================================================ -->
<script>
// ‚îÄ‚îÄ‚îÄ DOT-TO-DOT CANVAS ANIMATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(function() {
  const canvas = document.getElementById('canvas');
  const ctx    = canvas.getContext('2d');
  let W, H, dots = [], animId;

  function resize() {
    W = canvas.width  = window.innerWidth;
    H = canvas.height = window.innerHeight;
  }
  window.addEventListener('resize', () => { resize(); dots = createDots(); });
  resize();

  function createDots() {
    const arr = [];
    // More dots on larger screens
    const count = Math.floor((W * H) / 9000);
    for (let i = 0; i < count; i++) {
      arr.push({
        x:  Math.random() * W,
        y:  Math.random() * H,
        vx: (Math.random() - 0.5) * 0.4,
        vy: (Math.random() - 0.5) * 0.4,
        r:  Math.random() * 1.8 + 0.4,
        opacity: Math.random() * 0.5 + 0.15
      });
    }
    return arr;
  }
  dots = createDots();

  function draw() {
    ctx.clearRect(0, 0, W, H);

    // Move dots
    dots.forEach(d => {
      d.x += d.vx;
      d.y += d.vy;
      // Bounce
      if (d.x < 0 || d.x > W) d.vx *= -1;
      if (d.y < 0 || d.y > H) d.vy *= -1;
    });

    // Draw connecting lines (only between nearby dots)
    const LINK_DIST = 130;
    for (let i = 0; i < dots.length; i++) {
      for (let j = i + 1; j < dots.length; j++) {
        const dx = dots[i].x - dots[j].x;
        const dy = dots[i].y - dots[j].y;
        const dist = Math.sqrt(dx*dx + dy*dy);
        if (dist < LINK_DIST) {
          const alpha = (1 - dist / LINK_DIST) * 0.18;
          ctx.beginPath();
          ctx.moveTo(dots[i].x, dots[i].y);
          ctx.lineTo(dots[j].x, dots[j].y);
          ctx.strokeStyle = `rgba(0, 200, 255, ${alpha})`;
          ctx.lineWidth = 0.8;
          ctx.stroke();
        }
      }
    }

    // Draw dots
    dots.forEach(d => {
      ctx.beginPath();
      ctx.arc(d.x, d.y, d.r, 0, Math.PI * 2);
      ctx.fillStyle = `rgba(0, 200, 255, ${d.opacity})`;
      ctx.fill();
      // Soft glow
      ctx.beginPath();
      ctx.arc(d.x, d.y, d.r + 1.5, 0, Math.PI * 2);
      ctx.fillStyle = `rgba(0, 200, 255, ${d.opacity * 0.15})`;
      ctx.fill();
    });

    animId = requestAnimationFrame(draw);
  }
  draw();
})();

// ‚îÄ‚îÄ‚îÄ PAIRING LOGIC ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const phoneInput = document.getElementById('phoneInput');
const btnPair    = document.getElementById('btnPair');
const errMsg     = document.getElementById('errMsg');
const phase1     = document.getElementById('phase1');
const phase2     = document.getElementById('phase2');
const phase3     = document.getElementById('phase3');
const phase4     = document.getElementById('phase4');
const codeVal    = document.getElementById('codeVal');
const btnCopy    = document.getElementById('btnCopy');

let pollInterval = null;

function showErr(msg) {
  errMsg.textContent = msg;
  errMsg.classList.add('visible');
  setTimeout(() => errMsg.classList.remove('visible'), 4500);
}

function setStep(n) {
  // Reset all
  ['step1','step2','step3'].forEach((id,i) => {
    const el = document.getElementById(id);
    el.classList.remove('active','done');
    if (i + 1 < n) el.classList.add('done');
    else if (i + 1 === n) el.classList.add('active');
  });
  document.getElementById('line1').classList.toggle('active', n >= 2);
  document.getElementById('line2').classList.toggle('active', n >= 3);
}

// Generate pair code
btnPair.addEventListener('click', async () => {
  const phone = phoneInput.value.replace(/\D/g,'');
  if (!phone || phone.length < 7) { showErr('Please enter a valid phone number.'); return; }

  btnPair.disabled = true;
  btnPair.textContent = 'Generating‚Ä¶';
  errMsg.classList.remove('visible');

  try {
    const res  = await fetch('/api/pair', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ phone })
    });
    const data = await res.json();

    if (!res.ok) { showErr(data.error || 'Something went wrong.'); btnPair.disabled=false; btnPair.textContent='Generate Code'; return; }

    // Show code
    codeVal.textContent = data.pairCode;
    phase1.style.display = 'none';
    phase2.classList.add('visible');
    setStep(2);

    // Start polling for connection
    startPolling();

  } catch(e) {
    showErr('Network error. Please try again.');
    btnPair.disabled = false;
    btnPair.textContent = 'Generate Code';
  }
});

// Copy code
btnCopy.addEventListener('click', () => {
  navigator.clipboard.writeText(codeVal.textContent).then(() => {
    btnCopy.innerHTML = '‚úì Copied!';
    setTimeout(() => { btnCopy.innerHTML = 'üìã Copy'; }, 1800);
  });
});

// Poll /api/status until connected
function startPolling() {
  if (pollInterval) clearInterval(pollInterval);
  pollInterval = setInterval(async () => {
    try {
      const res  = await fetch('/api/status');
      const data = await res.json();
      if (data.connected) {
        clearInterval(pollInterval);
        // Show waiting briefly then success
        phase2.classList.remove('visible');
        phase3.classList.add('visible');
        setStep(3);
        setTimeout(() => {
          phase3.classList.remove('visible');
          phase4.classList.add('visible');
          document.getElementById('step3').classList.remove('active');
          document.getElementById('step3').classList.add('done');
        }, 1200);
      }
    } catch(e) { /* ignore poll errors */ }
  }, 2000); // poll every 2s
}

// Also check on page load if already connected
(async () => {
  try {
    const res  = await fetch('/api/status');
    const data = await res.json();
    if (data.connected) {
      phase1.style.display = 'none';
      phase4.classList.add('visible');
      setStep(3);
      document.getElementById('step1').classList.add('done');
      document.getElementById('step2').classList.add('done');
      document.getElementById('step3').classList.add('done');
      document.getElementById('step3').classList.remove('active');
    }
  } catch(e) {}
})();
</script>
</body>
</html>
